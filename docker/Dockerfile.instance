FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive

# Copy setup scripts first (they drive the install)
COPY scripts/instance/setup.sh /opt/cloudcode/setup.sh
COPY scripts/instance/start-session.sh /opt/cloudcode/start-session.sh
COPY scripts/instance/claude-layout.kdl /opt/cloudcode/claude-layout.kdl
COPY docker/entrypoint.sh /entrypoint.sh
RUN chmod +x /opt/cloudcode/setup.sh /opt/cloudcode/start-session.sh /entrypoint.sh

# Run the idempotent setup script
RUN /opt/cloudcode/setup.sh

# Install the Zellij layout
RUN mkdir -p /home/claude/.config/zellij/layouts && \
    cp /opt/cloudcode/claude-layout.kdl /home/claude/.config/zellij/layouts/claude.kdl && \
    chown -R claude:claude /home/claude/.config/zellij

# Copy session helper to claude's home
RUN cp /opt/cloudcode/start-session.sh /home/claude/start-session.sh && \
    chown claude:claude /home/claude/start-session.sh

# Instance agent (Node.js sidecar)
COPY scripts/instance/agent /opt/cloudcode/agent
RUN cd /opt/cloudcode/agent && npm install --production

# Expose mosh UDP ports, ttyd, and agent
EXPOSE 60000-60010/udp 7681 3001

USER claude
WORKDIR /claude-data

ENTRYPOINT ["/entrypoint.sh"]
