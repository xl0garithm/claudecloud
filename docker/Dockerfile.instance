FROM ubuntu:24.04

ENV DEBIAN_FRONTEND=noninteractive

# Copy setup scripts first (they drive the install)
COPY scripts/instance/setup.sh /opt/cloudcode/setup.sh
COPY scripts/instance/connect.sh /opt/cloudcode/connect.sh
COPY scripts/instance/claude-layout.kdl /opt/cloudcode/claude-layout.kdl
COPY scripts/instance/zellij-config.kdl /opt/cloudcode/zellij-config.kdl
COPY docker/entrypoint.sh /entrypoint.sh
COPY docker/supervisor.sh /supervisor.sh
RUN chmod +x /opt/cloudcode/setup.sh /opt/cloudcode/connect.sh /entrypoint.sh /supervisor.sh

# Run the idempotent setup script
RUN /opt/cloudcode/setup.sh

# Install Zellij config and layout
RUN mkdir -p /home/claude/.config/zellij/layouts && \
    cp /opt/cloudcode/zellij-config.kdl /home/claude/.config/zellij/config.kdl && \
    cp /opt/cloudcode/claude-layout.kdl /home/claude/.config/zellij/layouts/claude.kdl && \
    chown -R claude:claude /home/claude/.config/zellij

# Copy connect script to claude's home (used by ttyd to attach to Zellij)
RUN cp /opt/cloudcode/connect.sh /home/claude/connect.sh && \
    chmod +x /home/claude/connect.sh && \
    chown claude:claude /home/claude/connect.sh

# Instance agent (Node.js sidecar)
COPY scripts/instance/agent /opt/cloudcode/agent
RUN cd /opt/cloudcode/agent && npm install --production

# Expose mosh UDP ports, ttyd, and agent
EXPOSE 60000-60010/udp 7681 3001

# Health check: verify ttyd and agent are responding
HEALTHCHECK --interval=30s --timeout=5s --retries=3 \
    CMD curl -sf http://localhost:7681/ > /dev/null && \
        curl -sf -H "Authorization: Bearer $AGENT_SECRET" http://localhost:3001/projects > /dev/null || exit 1

USER claude
WORKDIR /claude-data

ENTRYPOINT ["/entrypoint.sh"]
